{% requirePermission "seomatic:site-settings" %}

{% extends "_layouts/cp" %}

{% from "seomatic/settings/_includes/macros.twig" import configWarning %}
{% import "_includes/forms" as forms %}

{% set tabs = {} %}
{% for scriptHandle,scriptData in scripts %}
    {% set permission = "seomatic:tracking-scripts:#{scriptHandle}" %}
    {% if currentUser.can(permission) %}
        {% set tabs = tabs |merge({
            "${scriptHandle}": {
                url: "#tab-tracking-#{scriptHandle}",
                label: "#{scriptData.name}" |t("seomatic"),
            },
        }) %}
    {% endif %}
{% endfor %}

{% block header %}
    {{ block('pageTitle') }}
    {{ block('contextMenu') }}
    <div class="flex-grow"></div>
    <div class="flex-grow"></div>
    {{ block('actionButton') }}
{% endblock %}

{% block contextMenu %}
    {% include "seomatic/settings/_includes/sites-menu.twig" %}
{% endblock %}

{% block content %}
    
    <input type="hidden" name="action" value="seomatic/settings/save-tracking">
    <input type="hidden" name="siteId" value="{{ currentSiteId }}">
    {{ redirectInput("seomatic/tracking/#{currentSiteHandle}") }}

    {% for scriptHandle,scriptData in scripts %}
        {% set permission = "seomatic:tracking-scripts:#{scriptHandle}" %}
        {% if currentUser.can(permission) %}
            <div id="tab-tracking-#{scriptHandle}">
                {% namespace "scripts[#{scriptHandle}]" %}
                    {{ forms.lightswitchField({
                        label: "#{scriptData.name}" |t("seomatic"),
                        instructions: "#{scriptData.description}" |t("seomatic"),
                        id: "include",
                        name: "include",
                        on: scriptData.include,
                        warning: false,
                    }) }}

                    {% for varHandle,varData in scriptData.vars %}
                        {% switch varData.type %}
                            {% case "bool" %}
                                {{ forms.lightswitchField({
                                    label: "#{varData.title}" |t("seomatic"),
                                    instructions: "#{varData.instructions}" |t("seomatic"),
                                    id: "vars-#{varHandle}",
                                    name: "vars[#{varHandle}]",
                                    on: varData.value,
                                    warning: false,
                                }) }}

                            {% case "string" %}
                                {{ forms.textField({
                                    label: "#{varData.title}" |t("seomatic"),
                                    instructions: "#{varData.instructions}" |t("seomatic"),
                                    id: "vars-#{varHandle}",
                                    name: "vars[#{varHandle}]",
                                    value: varData.value ?? "",
                                    warning: false,
                                }) }}

                            {% default %}

                        {% endswitch %}
                    {% endfor %}

                    {{ forms.textAreaField({
                        label: "Script Template" |t("seomatic"),
                        instructions: "You can edit the script here." |t("seomatic") |raw,
                        id: "templateString",
                        name: "templateString",
                        value: scriptData.templateString,
                        class: "seomatic-javascript-editor",
                        warning: false,
                    }) }}

                {% endnamespace %}
            </div>
        {% endif %}
    {% endfor %}

    {% include "seomatic/_includes/footer-message.twig" with {
        message: "Stuff."
    } %}
{% endblock %}
